<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CNY Separate Export Pro</title>
    <style>
        body { margin: 0; background: #e0e0e0; overflow: hidden; font-family: sans-serif; }
        #ui { position: absolute; top: 15px; left: 15px; z-index: 100; pointer-events: auto; }
        .seed-box { background: rgba(255,255,255,0.95); padding: 8px 15px; border-radius: 12px; border: 1px solid #aaa; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #seed-input { background: transparent; border: none; font-size: 26px; font-weight: 900; color: #000; width: 160px; outline: none; }
        .controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; flex-wrap: wrap; gap: 8px; pointer-events: auto; background: rgba(255,255,255,0.95); padding: 12px; border-radius: 15px; width: 92%; justify-content: center; border: 1px solid #ddd; }
        button { background: #fff; border: 1px solid #ccc; padding: 12px 18px; border-radius: 8px; font-weight: bold; font-size: 13px; }
        button.active { background: #000; color: #fff; border-color: #000; }
        .btn-exp { background: #28a745; color: #fff; border: none; }
        #status { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); color:white; padding:25px; z-index:1000; border-radius:15px; text-align:center; }
    </style>
</head>
<body>
<div id="ui">
    <div class="seed-box">
        <span style="font-size: 10px; color: #777; font-weight: bold; letter-spacing: 1px; display:block;">SEED</span>
        <input type="number" id="seed-input" value="30055895" onchange="updateSeed(this.value)">
    </div>
</div>
<div id="status">正在处理资产...</div>
<div class="controls">
    <button id="m-land" class="active" onclick="setWorld('land')">内陆</button>
    <button id="m-coast" onclick="setWorld('coast')">海岸</button>
    <button id="m-island" onclick="setWorld('island')">海岛</button>
    <button onclick="randomSeed()">随机</button>
    <button class="btn-exp" onclick="exportTextureOnly()">下载 4K 贴图 (FIXED)</button>
</div>
<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
let scene, camera, renderer, controls, terrain;
let worldSeed = 30055895;
let worldType = 'land';
const size = 256; 

// 噪声生成核心逻辑（保留原代码）
function hash(n) { n = Math.sin(n) * 43758.5453; return n - Math.floor(n); }
function noise(x, y) {
    const i = Math.floor(x), f = x - i;
    const j = Math.floor(y), g = y - j;
    const a = hash(i + j * 57 + worldSeed);
    const b = hash(i + 1 + j * 57 + worldSeed);
    const c = hash(i + (j + 1) * 57 + worldSeed);
    const d = hash(i + 1 + (j + 1) * 57 + worldSeed);
    return a + (b-a)*(f*f*(3-2*f)) + (c-a)*(g*g*(3-2*g)) + (a-b-c+d)*(f*f*(3-2*f))*(g*g*(3-2*g));
}

// 高度获取逻辑（保留原代码）
function getH(x, y) {
    let v = 0, a = 1.0, f = 0.0055;
    for(let i=0; i<8; i++) {
        let n = noise(x * f, y * f);
        n = 1.0 - Math.abs(n * 2.0 - 1.0);
        v += a * n;
        f *= 2.1; a *= 0.48;
    }
    let h = Math.pow(v, 2.6) * 75 - 20;
    if(worldType === 'island') {
        let dist = Math.sqrt(Math.pow(x-size/2,2) + Math.pow(y-size/2,2)) / (size/2);
        h = (h + 20) * Math.pow(Math.max(0, 1.15 - dist), 1.6) - 20;
    } else if(worldType === 'coast') {
        let shelf = Math.smoothstep(x / size, 0.45, 0.95);
        h = h * (1.0 - shelf) - (shelf * 18);
    }
    return h;
}

// 平滑步长（保留原代码）
Math.smoothstep = (x, min, max) => {
    if (x <= min) return 0; if (x >= max) return 1;
    x = (x - min) / (max - min); return x * x * (3 - 2 * x);
};

// 初始化3D场景（保留原代码）
function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xe0e0e0);
    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 1, 8000);
    camera.position.set(450, 450, 450);
    renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    const sun = new THREE.DirectionalLight(0xffffff, 1.4);
    sun.position.set(300, 500, 200);
    scene.add(sun);
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    build();
    animate();
}

// 构建地形（保留原代码，仅替换颜色逻辑）
function build() {
    if(terrain) { scene.remove(terrain); terrain.geometry.dispose(); terrain.material.dispose(); }
    const geo = new THREE.PlaneGeometry(1500, 1500, size-1, size-1);
    const pos = geo.attributes.position.array;
    const colors = new Float32Array(size * size * 3);
    for(let i=0; i<size*size; i++) {
        const x = i % size, y = Math.floor(i / size);
        const h = getH(x, y);
        pos[i*3 + 2] = h;
        let c = getPixelColor(h);
        colors[i*3] = c.r; colors[i*3+1] = c.g; colors[i*3+2] = c.b;
    }
    geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    geo.computeVertexNormals();
    terrain = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ vertexColors: true, roughness: 1.0 }));
    terrain.rotation.x = -Math.PI / 2;
    scene.add(terrain);
}

// 核心：米制高程硬分层颜色逻辑（按最终要求定制）
function getPixelColor(h) {
    // 海拔换算：1h = 10米
    const meter = h * 10;
    // 海岛模式雪线抬高（1100米），其他模式默认雪线（800米）
    const snowLineH = worldType === 'island' ? 110 : 80;

    // 海洋分层（≤0米）- 硬分层无渐变
    if (meter <= -50) return {r: 20/255, g: 40/255, b: 100/255}; // 最深蓝
    if (meter <= -20) return {r: 40/255, g: 80/255, b: 160/255}; // 深蓝色
    if (meter <= 0)   return {r: 90/255, g: 160/255, b: 220/255};// 浅蓝色

    // 雪线分层（海岛≥1100米/内陆/海岸≥800米）
    if (h >= snowLineH) return {r: 1, g: 1, b: 1}; // 纯白色

    // 陆地分层（0-800/1100米）- 硬分层无渐变
    if (meter >= 600) return {r: 160/255, g: 110/255, b: 60/255}; // 棕色
    if (meter >= 400) return {r: 230/255, g: 200/255, b: 80/255}; // 黄色
    if (meter >= 200) return {r: 50/255, g: 130/255, b: 40/255};  // 深绿色
    if (meter >= 100) return {r: 90/255, g: 190/255, b: 60/255};  // 绿色
    return {r: 150/255, g: 230/255, b: 120/255};                  // 浅绿色
}

// 恢复4K贴图导出功能（保留原镜像翻转逻辑，匹配分层颜色）
window.exportTextureOnly = async () => {
    document.getElementById('status').innerText = "正在生成贴图...";
    document.getElementById('status').style.display = 'block';
    await new Promise(r => setTimeout(r, 50));
    const res = 4096; // 4K分辨率
    const canvas = document.createElement('canvas');
    canvas.width = res; canvas.height = res;
    const ctx = canvas.getContext('2d');
    const imgData = ctx.createImageData(res, res);
    for(let i=0; i<res*res; i++) {
        const tx = i % res;
        const ty = Math.floor(i / res);
        // 原镜像翻转逻辑，保证贴图方向正确
        const h = getH((tx/res)*size, ((res - 1 - ty)/res)*size);
        const c = getPixelColor(h);
        const idx = i * 4;
        imgData.data[idx]=c.r*255; imgData.data[idx+1]=c.g*255; imgData.data[idx+2]=c.b*255; imgData.data[idx+3]=255;
    }
    ctx.putImageData(imgData, 0, 0);
    const link = document.createElement('a');
    link.href = canvas.toDataURL("image/png");
    link.download = `CNY_TEXTURE_4K_${worldSeed}.png`;
    link.click();
    document.getElementById('status').style.display = 'none';
};

// 种子更新（保留原代码）
window.updateSeed = (val) => {
    let s = parseInt(val);
    if(isNaN(s)) s = 30055895;
    if(s > 99999999) s = 99999999;
    worldSeed = s; build();
};

// 随机种子（保留原代码）
window.randomSeed = () => {
    const s = Math.floor(Math.random() * 90000000) + 10000000;
    document.getElementById('seed-input').value = s;
    window.updateSeed(s);
};

// 地形模式切换（保留原代码）
window.setWorld = (t) => {
    worldType = t;
    ['land', 'coast', 'island'].forEach(k => document.getElementById('m-'+k).className = '');
    document.getElementById('m-'+t).className = 'active';
    build();
};

// 动画渲染（保留原代码）
function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

// 初始化执行
init();
</script>
</body>
</html>
